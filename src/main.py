from fastapi import FastAPI, HTTPException, Depends
from pydantic import BaseModel
from sqlalchemy import create_engine, Integer, String, func, Boolean
from sqlalchemy.orm import sessionmaker, mapped_column, Mapped, Session, DeclarativeBase
import uvicorn
import sys
import os
from dotenv import load_dotenv
import time
import sqlite3
import datetime
from fastapi.responses import FileResponse
from urllib.parse import quote
from fastapi.staticfiles import StaticFiles
import json
from fastapi import FastAPI, Response

sys.path.append(os.path.dirname(__file__))

load_dotenv()

app = FastAPI()

PROD = os.getenv('PROD', '0') == '1'

# Database setup
DATABASE_FILEPATH = '/db/prod/label_work.db' if PROD else '/db/test/label_work.db'
engine = create_engine(f'sqlite://{DATABASE_FILEPATH}')
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

class Base(DeclarativeBase):
    pass

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


# TODO: probably need measurement link
class LabelTask(Base):
    __tablename__ = 'label_tasks'

    id: Mapped[int] = mapped_column(Integer, primary_key=True, index=True)
    fmc_id: Mapped[str] = mapped_column(String, index=True)
    measurement_checksum: Mapped[str] = mapped_column(String, unique=True, index=True)
    fmc_data: Mapped[str] = mapped_column(String)
    sia_meas_id_path: Mapped[str] = mapped_column(String)

    # 0 means not sent out yet
    sent_label_request_at_epoch: Mapped[int] = mapped_column(Integer, default=0)
    last_labeler: Mapped[str | None] = mapped_column(String, nullable=True, default=None)

    is_labeled: Mapped[bool] = mapped_column(Boolean, default=False)
    label_bolf_path: Mapped[str | None] = mapped_column(String, nullable=True, default=None)

    created_at_epoch: Mapped[int] = mapped_column(Integer)


class SkippedTaskCreate(BaseModel):
    sia_link: str
    skip_reason: str


class SkippedTask(Base):
    __tablename__ = 'skipped_tasks'
    id: Mapped[int] = mapped_column(Integer, primary_key=True, index=True)
    # raw content pasted into text field
    sia_link: Mapped[str] = mapped_column(String, index=True)
    skip_reason: Mapped[str] = mapped_column(String, index=True)


class Metric(Base):
    __tablename__ = 'metrics_history'

    id: Mapped[int] = mapped_column(Integer, primary_key=True, index=True)
    created_at_epoch: Mapped[int] = mapped_column(Integer)

    total_labelable: Mapped[int] = mapped_column(Integer)
    labeled: Mapped[int] = mapped_column(Integer)
    not_labeled: Mapped[int] = mapped_column(Integer)
    opened: Mapped[int] = mapped_column(Integer)
    opened_pending: Mapped[int] = mapped_column(Integer)


class LabelTaskCreate(BaseModel):
    fmc_id: str
    fmc_data: str
    measurement_checksum: str
    sia_meas_id_path: str


class LabeledTask(BaseModel):
    measurement_checksum: str
    label_bolf_path: str


@app.get('/api/get_task')
async def get_task(labeler_name: str, db: Session = Depends(get_db)):
    current_time_epoch = int(time.time())
    # TODO: i need to sync every min 4 days
    # TODO: remove LabeledTask.created_at_epoch < 1739449765 filter after video is there
    # TODO: replace created_at_epoch with recorded_epoch
    db_task = db.query(LabelTask).filter(LabelTask.is_labeled == False).filter((current_time_epoch - 60 * 60 * 24 * 4) > LabelTask.sent_label_request_at_epoch).order_by(func.random()).first()
    if not db_task:
        return {'finished': True}

    db_task.last_labeler = labeler_name
    db_task.sent_label_request_at_epoch = current_time_epoch

    encoded_name = quote(labeler_name)

    sia_url = f'https://dev.sia.bosch-automotive-mlops.com/?time=99999&minimalLabelMode=true&minimalLabelModeUsername={encoded_name}&measId={db_task.sia_meas_id_path}'

    db.commit()
    db.refresh(db_task)

    return {'task': db_task, 'sia_url': sia_url}


@app.get('/api/test_remove_realworld')
async def test_remove(db: Session = Depends(get_db)):
    db_tasks = db.query(LabelTask).all()

    cutoff_epoch = int(datetime.datetime.fromisoformat('2025-02-10T10:16:35.000Z'.replace('Z', '+00:00')).timestamp())

    ids_to_delete = []

    for task in db_tasks:
        fmc_data_dict = json.loads(task.fmc_data)
        if type(fmc_data_dict) != dict:
            continue
        if 'recordingDate' not in fmc_data_dict:
            continue
        recDate = fmc_data_dict['recordingDate']
        recEpoch = int(datetime.datetime.fromisoformat(recDate.replace('Z', '+00:00')).timestamp())
        if recEpoch > cutoff_epoch:
            ids_to_delete.append(task.id)
            print(recEpoch, cutoff_epoch)

    del_count = 0

    for id_val in ids_to_delete:
        row_to_delete = db.query(LabelTask).filter(LabelTask.id == id_val).first()
        if row_to_delete:
            db.delete(row_to_delete)
            del_count += 1
    
    db.commit()

    return {'del_count': del_count, 'sum': len(ids_to_delete)}



@app.post('/api/set_labeled')
async def set_labeled(tasks: list[LabeledTask], db: Session = Depends(get_db)):
    if not tasks:
        raise HTTPException(status_code=400, detail='No tasks provided')

    created_labeled_tasks = []

    for task in tasks:
        db_task = db.query(LabelTask).filter(LabelTask.measurement_checksum == task.measurement_checksum).first()
        if not db_task:
            print(f'Unknown task {task}')
            continue

        db_task.label_bolf_path = task.label_bolf_path
        db_task.is_labeled = True
        db.commit()

        created_labeled_tasks.append(task.model_dump())

    return created_labeled_tasks


@app.post('/api/add_tasks')
async def add_tasks(tasks: list[LabelTaskCreate], db: Session = Depends(get_db)):
    if not tasks:
        raise HTTPException(status_code=400, detail='No tasks provided')

    current_time = int(time.time())
    created_tasks = []

    for task in tasks:
        # TODO: check if fmc_data has correct data fields for later
        if not task.fmc_id or not task.fmc_data or not task.measurement_checksum:
            raise HTTPException(status_code=400, detail=f'Invalid Task {task}')

        db_task = db.query(LabelTask).filter(LabelTask.measurement_checksum == task.measurement_checksum).first()
        if db_task:
            print(f'Skipping Task {task}, already in db.')
            continue

        db_task = LabelTask(
            fmc_id=task.fmc_id,
            fmc_data=task.fmc_data,
            measurement_checksum=task.measurement_checksum,
            sia_meas_id_path=task.sia_meas_id_path,
            created_at_epoch=current_time
        )
        db.add(db_task)
        db.commit()
        created_tasks.append(task.model_dump())

    return {'created_tasks': created_tasks}

@app.post('/api/skip_task')
async def set_skipped(skipped_task: SkippedTaskCreate, db: Session = Depends(get_db)):
    if not skipped_task.sia_link:
        raise HTTPException(status_code=400, detail=f'Invalid sia_link {skipped_task.sia_link}')
    skip_task = SkippedTask(sia_link=skipped_task.sia_link, skip_reason=skipped_task.skip_reason)
    db.add(skip_task)
    db.commit()
    db.refresh(skip_task)
    return skip_task


@app.get('/api/backup_db')
async def backup_db():
    current_time = datetime.datetime.now().strftime('%Y_%m_%d_%H_%M_%S')
    if PROD:
        backup_path = f'/db/prod/backup/label_work_{current_time}.db'
    else:
        backup_path = f'/db/test/backup/label_work_{current_time}.db'

    source_con = sqlite3.connect(DATABASE_FILEPATH)
    backup_con = sqlite3.connect(backup_path)

    with backup_con:
        source_con.backup(backup_con)

    backup_con.close()
    source_con.close()


@app.get('/api/metrics')
async def get_metrics(db: Session = Depends(get_db)):
    total_count = db.query(LabelTask).count()
    labeled = db.query(LabelTask).filter(LabelTask.is_labeled == True).count()
    not_labeled = db.query(LabelTask).filter(LabelTask.is_labeled == False).count()
    opened = db.query(LabelTask).filter(LabelTask.sent_label_request_at_epoch != 0).count()

    metrics = {
        'total_labelable': total_count,
        'labeled': labeled,
        'not_labeled': not_labeled,
        'opened': opened,
        'opened_pending': opened - labeled
    }

    metric = Metric(**metrics, created_at_epoch=int(time.time()))
    db.add(metric)
    db.commit()

    return metrics


@app.get('/api/metrics_history')
async def get_metrics_history(db: Session = Depends(get_db)):
    return db.query(Metric).order_by(Metric.created_at_epoch).all()


@app.get('/api/leaderboard')
async def leaderboard(db: Session = Depends(get_db)):
    leaderboard_data = db.query(LabelTask.last_labeler, func.count()).filter(LabelTask.last_labeler != None).group_by(LabelTask.last_labeler).all()
    leaderboard = {}
    for labeler, count in leaderboard_data:
        leaderboard[labeler] = count
    
    sorted_leaderboard_items = sorted(leaderboard.items(), key=lambda item: item[1], reverse=True)
    top_20_items = sorted_leaderboard_items[:20]
    return {labeler: count for labeler, count in top_20_items}

@app.get('/api/db_cleanup')
async def db_cleanup(db: Session = Depends(get_db)):
    # TODO: check if int or str needed
    valid_ids = ["265229", "362507", "362512", "362513", "362515", "362516", "362517", "362518", "362519", "362520", "362521", "362522", "362523", "362525", "362526", "362527", "362528", "362529", "362530", "362531", "362532", "362534", "362535", "362536", "362537", "362539", "362540", "362541", "362553", "362554", "362555", "362556", "362557", "362567", "362568", "362569", "362577", "362578", "362579", "362580", "362581", "362582", "362583", "362591", "362592", "362593", "362603", "362604", "362605", "362606", "362607", "362608", "362609", "362610", "362618", "362619", "362620", "362622", "362623", "362624", "362625", "362626", "362627", "362639", "362640", "362641", "362642", "362643", "362656", "362657", "362658", "362659", "362660", "362661", "362662", "362670", "362671", "362672", "362673", "362674", "362675", "362676", "362677", "362687", "362688", "362689", "362691", "362692", "362693", "362704", "362709", "362740", "362792", "362793", "362794", "362795", "362796", "362797", "362798", "362808", "362809", "362810", "362811", "362825", "362826", "362827", "362828", "362829", "362830", "362831", "362832", "362833", "362842", "362843", "362853", "362854", "362855", "362856", "362872", "362873", "362874", "362875", "362876", "362877", "362878", "362879", "362880", "362881", "362882", "362883", "362892", "362893", "362894", "362895", "362903", "362904", "362905", "362906", "362907", "362908", "362909", "362910", "362911", "362912", "362913", "362914", "362915", "362916", "362917", "362918", "362925", "362926", "362927", "362928", "362938", "362939", "362940", "362941", "362943", "362944", "362945", "362954", "362956", "362965", "362966", "362967", "362968", "362969", "362970", "362971", "362972", "362986", "362987", "362988", "362989", "362990", "362998", "362999", "363000", "363001", "363002", "363003", "363015", "363016", "363017", "363018", "363019", "363020", "363021", "363022", "363023", "363034", "363035", "363036", "363037", "363039", "363040", "363049", "363050", "363052", "363053", "363054", "363055", "363077", "363134", "363135", "363136", "363137", "363147", "363148", "363149", "363150", "363152", "363153", "363154", "363165", "363166", "363174", "363175", "363185", "363186", "363187", "363188", "363189", "363191", "363192", "363193", "363209", "363210", "363211", "363212", "363213", "363214", "363215", "363216", "363218", "363219", "363220", "363221", "363222", "363233", "363234", "363235", "363236", "363237", "363238", "363245", "363246", "363247", "363248", "363249", "363250", "363251", "363252", "363253", "363254", "363255", "363266", "363267", "363268", "363269", "363270", "363271", "363272", "363273", "363274", "363282", "363284", "363290", "363291", "363292", "363305", "363306", "363307", "363308", "363309", "363310", "363311", "363312", "363322", "363323", "363324", "363330", "363337", "363338", "364413", "364414", "364415", "364416", "364417", "364418", "364419", "364420", "364421", "364422", "364424", "364426", "364427", "364428", "364430", "364431", "364432", "364433", "364434", "364435", "364436", "364437", "364439", "364548", "364549", "364550", "364551", "364552", "364553", "364555", "364556", "364557", "364558", "364560", "364562", "364563", "364565", "364566", "364567", "364568", "364569", "364570", "364571", "364572", "364573", "364574", "364575", "364578", "364579", "364580", "364581", "364582", "364583", "364584", "364586", "364587", "364588", "364589", "364592", "364593", "364594", "364595", "364597", "364598", "364599", "364600", "364601", "364602", "364603", "364604", "364605", "364606", "364607", "364608", "364609", "364610", "364611", "364612", "364613", "364614", "364615", "364617", "364619", "364622", "364623", "364624", "364625", "364627", "364629", "364630", "364631", "364632", "364633", "364634", "364635", "364636", "364637", "364638", "364640", "364641", "364642", "364643", "364644", "364645", "364646", "364647", "364648", "364649", "364650", "364651", "364652", "364653", "364654", "364655", "364656", "364657", "364659", "364660", "364661", "364662", "364663", "364664", "364665", "364666", "364667", "364668", "364669", "364720", "364721", "364722", "364726", "364727", "364728", "364729", "364730", "364731", "364732", "364733", "364734", "364735", "364736", "364737", "364738", "364739", "364740", "364741", "364742", "364743", "364744", "364745", "364746", "364747", "364748", "364749", "364751", "364752", "364753", "364754", "364755", "364756", "364757", "364758", "364759", "364760", "364761", "364762", "364763", "364765", "364767", "364768", "364769", "364770", "364771", "364772", "364773", "364774", "364775", "364776", "364777", "364778", "364779", "364780", "364781", "364782", "364783", "364784", "364785", "364786", "364787", "364788", "364789", "364790", "364791", "364792", "364793", "364794", "364795", "364796", "364798", "364799", "364800", "364801", "364802", "364803", "364804", "364805", "364806", "364807", "364808", "364809", "364810", "364811", "364812", "364813", "364814", "364815", "364816", "364817", "364818", "364819", "364820", "364821", "364822", "364823", "364824", "364825", "364826", "364827", "364828", "364829", "364830", "364831", "364832", "364833", "364834", "364836", "364837", "364838", "364839", "364840", "364841", "364842", "364843", "364844", "364845", "364846", "364847", "364848", "364849", "364850", "364851", "364852", "364853", "364854", "364855", "364856", "364857", "364858", "364859", "364860", "364861", "364862", "364863", "364864", "364865", "364866", "364868", "364869", "364870", "364871", "364872", "364873", "364874", "364875", "364876", "364877", "364878", "364879", "364880", "364881", "364882", "364883", "364884", "364885", "364886", "364887", "364888", "364889", "364890", "364891", "364892", "364893", "364894", "364895", "364896", "364897", "364898", "364899", "364900", "364901", "364902", "364903", "364904", "364905", "364906", "364907", "364908", "364909", "364910", "364911", "364912", "364914", "364915", "364916", "364917", "364918", "364919", "364920", "364921", "364922", "364923", "364924", "364925", "364926", "364927", "364929", "364930", "364931", "364932", "364933", "364934", "364935", "364936", "364937", "364938", "364939", "364941", "364943", "364944", "364945", "364946", "364947", "364948", "364949", "364951", "364952", "364953", "364954", "364955", "364956", "364957", "364958", "364959", "364960", "364961", "364962", "364963", "364964", "364965", "364966", "364968", "364969", "364970", "364971", "364973", "364974", "364975", "364976", "364977", "364978", "364979", "364980", "364981", "364983", "364984", "364985", "364986", "364987", "364988", "364990", "364991", "364992", "364993", "364994", "364995", "364996", "364997", "364998", "364999", "365000", "365001", "365002", "365003", "365004", "365005", "365006", "365007", "365008", "365009", "365010", "365011", "365012", "365013", "365014", "365015", "365016", "365017", "365018", "365019", "365020", "365021", "365022", "365023", "365024", "365025", "365026", "365027", "365028", "365029", "365030", "365031", "365032", "365033", "365034", "365036", "365038", "365039", "365041", "365042", "365043", "365044", "365045", "365046", "365047", "365048", "365049", "365050", "365051", "365052", "365053", "365055", "365056", "365057", "365058", "365059", "365060", "365061", "365062", "365063", "365064", "365065", "365066", "365068", "365069", "365070", "365071", "365072", "365073", "365074", "365076", "365077", "365078", "365079", "365080", "365081", "365082", "365083", "365084", "365085", "365086", "365087", "365088", "365089", "365090", "365092", "365093", "365095", "365096", "365097", "365098", "365099", "365100", "365101", "365102", "365104", "365106", "365107", "365108", "365109", "365110", "365111", "365112", "365113", "365114", "365115", "365116", "365117", "365118", "365119", "365120", "365121", "365122", "365123", "365124", "365125", "365126", "365128", "365130", "365131", "365132", "365133", "365134", "365136", "365137", "365138", "365140", "365141", "365142", "365143", "365144", "365145", "365146", "365147", "365148", "365149", "365150", "365151", "365153", "365154", "365155", "365156", "365157", "365158", "365159", "365161", "365162", "365164", "365165", "365166", "365167", "365170", "365183", "365184", "365185", "365186", "365187", "365189", "365190", "365192", "365193", "365196", "365197", "365199", "365200", "365201", "365202", "365203", "365204", "365205", "365206", "365207", "365209", "365211", "365213", "370649", "370650", "370651", "370652", "370654", "370655", "370656", "370657", "370658", "370659", "370660", "370661", "370662", "370663", "370665", "370666", "370667", "370669", "370671", "370673", "370674", "370676", "370677", "370678", "370679", "370680", "370681", "370682", "370684", "370685", "370686", "370687", "370688", "370689", "370692", "370693", "370694", "370695", "370696", "370697", "370698", "370700", "370701", "370702", "370703", "370704", "370705", "370706", "370707", "370708", "370709", "370710", "370711", "370712", "370713", "370714", "370715", "370716", "370717", "370718", "370719", "370720", "370721", "370722", "370723", "370724", "370725", "370726", "370727", "370728", "370729", "370730", "370731", "370732", "370733", "370734", "370735", "370736", "370737", "370738", "370740", "370741", "370742", "370743", "370744", "370745", "370746", "370747", "370748", "370749", "370750", "370751", "370752", "370754", "370755", "370756", "370757", "370758", "370759", "370760", "370761", "370762", "370763", "370764", "370765", "370767", "370768", "370769", "370770", "370771", "370772", "370773", "370774", "370775", "370776", "370777", "370778", "370780", "370781", "370782", "370783", "370784", "370785", "370786", "370787", "370788", "370789", "370790", "370791", "370792", "370793", "370794", "370795", "370796", "370797", "370798", "370799", "370800", "370801", "370802", "370804", "370805", "370806", "370807", "370808", "370809", "370810", "370811", "370812", "370813", "370814", "370815", "370817", "370823", "370824", "370827", "370828", "370829", "370830", "370831", "370832", "370833", "370834", "370835", "370836", "370838", "370839", "370840", "370841", "370842", "370843", "370845", "370846", "370847", "370848", "370849", "370850", "370851", "370853", "370855", "370856", "370858", "370859", "370860", "370862", "370864", "370865", "370867", "370868", "370869", "370870", "370871", "370872", "370873", "370875", "370876", "370878", "370879", "370880", "370881", "370882", "370883", "370884", "370885", "370886", "370887", "370888", "370889", "370890", "370891", "370892", "370893", "370894", "370895", "370896", "370897", "370898", "370899", "370900", "370901", "370902", "370903", "370904", "370905", "370906", "370907", "370908", "370911", "370912", "370913", "370914", "370915", "370916", "370917", "370919", "370920", "370922", "370923", "370924", "370925", "370926", "370927", "370929", "370931", "370932", "370933", "370934", "370936", "370937", "370940", "370941", "370943", "370944", "370945", "370947", "370952", "370953", "370955", "370956", "370957", "370959", "370960", "370962", "370963", "370965", "370970", "370971", "370979", "370986", "370987", "370992", "370994", "370997", "371007", "371011", "371013", "371014", "371015", "371016", "371017", "371018", "371019", "371020", "371021", "371022", "371023", "371024", "371025", "371026", "371052", "371053", "371054", "371055", "371057", "371058", "371059", "371061", "371062", "371063", "371064", "371065", "371067", "371068", "371069", "371070", "371071", "371072", "371075", "371076", "371078", "371079", "371081", "371086", "371088", "371090", "371093", "371094", "371095", "371096", "371098", "371100", "371101", "371102", "371121", "371122", "371123", "371124", "371126", "371127", "371128", "371129", "371130", "371131", "371133", "371134", "371135", "371136", "371137", "371138", "371139", "371162", "371163", "371164", "371165", "371166", "371627", "371668", "371734", "371754", "371917", "371966", "371987", "372032", "372052", "372094", "372095", "372119", "372120", "372121", "372142", "372143", "372144", "372185", "372186", "372212", "372213", "372214", "372215", "372234", "372235", "372236", "372808", "372809", "372810", "372811", "372812", "372813", "372814", "372815", "372816", "372817", "372818", "372819", "372820", "372821", "372822", "372823", "372824", "372825", "372826", "372827", "372828", "372829", "372830", "372831", "372832", "372833", "372834", "372835", "372836", "372837", "372838", "372839", "372840", "372841", "372842", "372843", "372844", "372845", "372846", "372847", "372848", "372849", "372850", "372851", "372852", "372853", "372854", "372855", "372856", "372857", "372858", "372859", "372860", "372861", "372862", "372863", "372864", "372865", "372866", "372867", "372868", "372869", "372870", "372871", "372872", "372873", "372874", "372877", "372878", "372879", "372880", "372881", "372882", "372883", "372884", "372885", "372886", "372887", "372888", "372889", "372890", "372891", "372892", "372893", "372894", "372895", "372896", "372897", "372898", "372899", "372900", "372901", "372902", "372903", "372904", "372905", "372906", "372907", "372908", "372909", "372910", "372911", "372912", "372913", "372914", "372915", "372916", "372917", "372918", "372920", "372921", "372922", "372923", "372925", "372926", "372927", "372930", "372931", "372932", "372933", "372934", "372935", "372936", "372938", "372939", "372940", "372941", "372942", "372943", "372944", "372945", "372946", "372947", "372948", "372949", "372950", "372951", "372952", "372953", "372954", "372955", "372956", "372957", "372958", "372959", "372960", "372961", "372962", "372963", "372964", "372965", "372966", "373002", "373004", "373005", "373006", "373007", "373008", "373009", "373010", "373011", "373012", "373014", "373015", "373016", "373017", "373018", "373019", "373020", "373021", "373022", "373023", "373024", "373026", "373027", "373028", "373029", "373030", "373031", "373032", "373033", "373034", "373035", "373036", "373037", "373038", "373040", "373041", "373042", "373044", "373045", "373046", "373047", "373048", "373049", "373050", "373051", "373052", "373053", "373054", "373077", "373078", "373079", "373080", "373081", "373082", "373084", "373085", "373086", "373087", "373088", "373089", "373091", "373093", "373094", "373095", "373096", "373097", "373098", "373099", "373100", "373101", "373102", "373103", "373104", "373105", "373106", "373107", "373108", "373109", "373110", "373111", "373112", "373113", "373114", "373115", "373116", "373117", "373118", "373119", "373120", "373121", "373122", "373123", "373124", "373125", "373126", "373127", "373128", "373129", "373130", "373131", "373133", "373135", "373195", "373199", "373200", "373201", "373202", "373203", "373204", "373209", "373214", "373220", "373222", "373223", "373224", "373225", "373226", "373227", "373229", "373230", "373231", "373232", "373233", "373234", "373235", "373236", "373237", "373238", "373239", "373240", "373241", "373245", "373250", "373251", "373252", "373253", "373254", "373258", "373259", "373260", "373261", "373262", "373263", "373264", "373267", "373272", "373274", "373275", "373276", "373281", "373283", "373284", "373285", "373288", "373289", "373292", "373293", "373295", "373296", "373297", "373298", "373299", "373300", "373301", "373302", "373303", "373304", "373305", "373306", "373307", "373308", "373309", "373310", "373311", "373312", "373313", "373314", "373315", "373316", "373318", "373319", "373321", "373322", "373323", "373324", "373325", "373326", "373327", "373328", "373329", "373330", "373331", "373332", "373333", "373334", "373335", "373336", "373337", "373339", "373340", "373342", "373343", "373344", "373345", "373346", "373347", "373348", "373349", "373350", "373351", "373352", "373353", "373354", "373355", "373356", "373357", "373358", "373359", "373360", "373361", "373362", "373363", "373364", "373365", "373366", "373367", "373368", "373369", "373370", "373371", "373372", "373373", "373374", "373375", "373376", "373377", "373378", "373379", "373380", "373381", "373382", "373383", "373384", "373385", "373386", "373387", "373388", "373389", "373390", "373391", "373392", "373393", "373394", "373395", "373396", "373397", "373398", "373399", "373400", "373401", "373402", "373403", "373404", "373405", "373406", "373407", "373408", "373409", "373410", "373411", "373412", "373413", "373414", "373415", "373416", "373417", "373418", "373419", "373420", "373421", "373422", "373423", "373424", "373425", "373426", "373427", "373428", "373429", "373430", "373431", "373432", "373433", "373434", "373436", "373438", "373439", "373440", "373442", "373443", "373444", "373445", "373446", "373447", "373448", "373449", "373450", "373451", "373452", "373453", "373454", "373456", "373457", "373459", "373460", "373461", "373462", "373463", "373464", "373465", "373466", "373470", "373471", "373473", "373474", "373476", "373479", "373481", "373482", "373484", "373492", "373578", "373579", "373581", "373582", "373583", "373584", "373585", "373586", "373588", "373589", "373590", "373591", "373592", "373593", "373594", "373595", "373596", "373597", "373598", "373599", "373600", "373601", "373602", "373604", "373605", "373606", "373607", "373608", "373609", "373612", "373615", "373616", "373617", "373618", "373619", "373620", "373621", "373622", "373623", "373624", "373625", "373626", "373627", "373628", "373629", "373630", "373631", "373632", "373633", "373634", "373635", "373636", "373637", "373638", "373639", "373640", "373641", "373642", "373643", "373644", "373645", "373646", "373647", "373648", "373649", "373651", "373652", "373653", "373654", "373655", "373656", "373657", "373659", "373660", "373661", "373662", "373663", "373664", "373665", "373666", "373667", "373668", "373669", "373670", "373671", "373672", "373673", "373674", "373675", "373676", "373677", "373678", "373679", "373680", "373681", "373682", "373683", "373684", "373685", "373686", "373687", "373688", "373689", "373690", "373691", "373692", "373693", "373694", "373695", "373696", "373697", "373698", "373699", "373700", "373701", "373702", "373703", "373704", "373705", "373706", "373707", "373708", "373709", "373710", "373711", "373712", "373713", "373714", "373716", "373717", "373718", "373719", "373720", "373721", "373722", "373723", "373724", "373725", "373726", "373727", "373728", "373729", "373733", "373894", "373895", "373896", "373897", "373898", "373899", "373900", "373902", "373903", "373904", "373905", "373906", "373907", "373908", "373909", "373910", "373911", "373912", "373913", "373914", "373915", "373916", "373917", "373918", "373919", "373920", "373921", "373922", "373923", "373924", "373925", "373927", "373928", "373929", "373930", "373931", "373932", "373933", "373934", "373935", "373936", "373937", "373938", "373939", "373940", "373941", "373942", "373943", "373944", "373945", "373946", "373947", "373948", "373949", "373950", "373951", "373952", "373953", "373954", "373955", "373956", "373957", "373958", "373959", "373960", "373961", "373962", "373963", "373964", "373965", "373966", "373967", "373968", "373969", "373970", "373971", "373972", "373973", "373974", "373975", "373976", "373977", "373978", "373979", "373980", "373982", "373983", "373984", "373986", "373987", "373988", "373989", "373990", "373991", "373993", "373994", "373995", "373996", "373997", "373998", "374000", "374001", "374002", "374003", "374004", "374005", "374093", "374102", "374103", "374104", "374105", "374106", "374107", "374108", "374110", "374113", "374114", "374118", "374120", "374124", "374125", "374127", "374128", "374132", "374134", "374138", "374139", "374140", "374141", "374144", "374148", "374150", "374151", "374153", "374154", "374156", "374159", "374160", "374162", "374163", "374164", "374165", "374166", "374167", "374168", "374169", "374170", "374172", "374174", "374175", "374177", "374178", "374179", "374180", "374181", "374182", "374183", "374185", "374186", "374187", "374188", "374190", "374191", "374192", "374193", "374194", "374196", "374197", "374198", "374199", "374201", "374202", "374206", "374209", "374210", "374212", "374213", "374215", "374216", "374217", "374219", "374220", "374221", "374222", "374225", "374227", "374228", "374230", "374231", "374232", "374234", "374237", "374240", "374242", "374244", "374246", "374255", "374259", "374261", "374271", "374273", "374276", "374277", "374278", "374283", "374286", "374287", "374289", "374291", "374295", "374296", "374297", "374299", "374304", "374305", "374308", "374310", "374311", "374313", "374315", "374319", "374324", "374330", "374332", "374333", "374336", "374338", "374340", "374342", "374346", "374348", "374350", "374351", "374352", "374353", "374355", "374358", "374360", "374362", "374364", "374365", "374367", "374372", "374375", "374378", "374379", "374383", "374386", "374390", "374392", "374396", "374401", "374403", "374406", "374407", "374415", "374417", "374418", "374420", "374424", "374428", "374435", "374437", "374438", "374443", "374446", "374448", "374452", "374453", "374454", "374457", "374459", "374464", "374465", "374468", "374469", "374471", "374480", "374484", "374487", "374489", "374490", "374491", "374494", "374499", "374500", "374502", "374504", "374506", "374509", "374511", "374515", "374523", "374528", "374533", "374537", "374544", "374547", "374549", "374553", "374555", "374560", "374561", "374563", "374565", "374566", "374568", "374570", "374571", "374572", "374574", "374578", "374580", "374583", "374585", "374586", "374587", "374588", "374590", "374591", "374592", "374593", "374594", "374595", "374598", "374599", "374600", "374602", "374603", "374604", "374605", "374607", "374608", "374609", "374610", "374611", "374612", "374613", "374614", "374615", "374616", "374617", "374618", "374619", "374621", "374622", "374623", "374624", "374625", "374626", "374627", "374630", "374633", "374634", "374635", "374637", "374638", "374639", "374640", "374641", "374643", "374645", "374647", "374649", "374650", "374652", "374653", "374655", "374656", "374657", "374658", "374660", "374661", "374663", "374664", "374665", "374666", "374668", "374669", "374670", "374671", "374673", "374674", "374675", "374677", "374678", "374679", "374682", "374683", "374684", "374686", "374687", "374689", "374690", "374691", "374692", "374693", "374694", "374695", "374696", "374698", "374699", "374701", "374702", "374706", "374708", "374709", "374710", "374712", "374714", "374716", "374717", "374718", "374719", "374720", "374721", "374723", "374725", "374726", "374729", "374734", "374737", "374739", "374744", "374746", "374747", "374748", "374749", "374750", "374751", "374752", "374754", "374755", "374759", "374761", "374762", "374766", "374767", "374770", "374772", "374774", "374777", "374779", "374781", "374787", "374789", "374791", "374792", "374794", "374795", "374797", "374798", "374799", "374801", "374804", "374806", "374807", "374809", "374812", "374813", "374815", "374816", "374817", "374819", "374822", "374823", "374824", "374826", "374828", "374830", "374831", "374832", "374833", "374835", "374837", "374838", "374841", "374844", "374845", "374846", "374847", "374851", "374853", "374854", "374860", "374861", "374867", "374868", "374870", "374872", "374873", "374878", "374879", "374881", "374883", "374884", "374888", "374891", "374892", "374893", "374898", "374900", "374902", "374906", "374908", "374910", "374911", "374912", "374913", "374914", "374916", "374917", "374918", "374920", "374921", "374923", "374924", "374927", "374929", "374930", "374933", "374935", "374936", "374938", "374941", "374943", "374944", "374946", "374947", "374948", "374951", "374954", "374955", "374957", "374958", "374959", "374960", "374961", "374965", "374967", "374968", "374969", "374971", "374972", "374973", "374974", "374975", "374978", "374979", "374980", "374984", "374985", "374986", "374989", "374990", "374992", "374994", "374995", "374996", "374997", "374998", "374999", "375000", "375002", "375003", "375005", "375147", "375148", "375151", "375152", "375153", "375154", "375156", "375158", "375160", "375163", "375166", "375167", "375168", "375169", "375170", "375172", "375173", "375176", "375178", "375181", "375182", "375184", "375185", "375186", "375187", "375188", "375189", "375190", "375194", "375203", "375204", "375205", "375206", "375207", "375208", "375209", "375210", "375211", "375212", "375213", "375215", "375217", "375220", "375221", "375223", "375224", "375225", "375226", "375227", "375228", "375229", "375230", "375233", "375236", "375237", "375238", "375239", "375240", "375241", "375245", "375246", "375247", "375248", "375249", "375250", "375251", "375252", "375253", "375257", "375259", "375260", "375263", "375264", "375265", "375266", "375267", "375268", "375269", "375273", "375274", "375276", "375277", "375278", "375280", "375282", "375284", "375286", "375287", "375290", "375292", "375293", "375294", "375296", "375298", "375302", "375303", "375304", "375305", "375307", "375309", "375310", "375312", "375314", "375315", "375317", "375319", "375320", "375325", "375326", "375328", "375330", "375331", "375333", "375334", "375336", "375337", "375338", "375339", "375340", "375341", "375343", "375344", "375345", "375346", "375347", "375348", "375349", "375350", "375351", "375352", "375354", "375355", "375356", "375357", "375358", "375359", "375360", "375361", "375363", "375365", "375366", "375368", "375369", "375370", "375371", "375372", "375373", "375374", "375375", "375376", "375377", "375378", "375382", "375383", "375384", "375386", "375388", "375392", "375393", "375394", "375395", "375396", "375402", "375403", "375405", "375406", "375407", "375409", "375410", "375412", "375414", "375415", "375418", "375422", "375423", "375424", "375425", "375426", "375429", "375435", "375437", "375443", "375444", "375447", "375450", "375462", "375465", "375467", "375482", "375520", "375537", "375550", "375569", "375587", "375606", "375626", "375651", "375672", "375673", "375701", "375702", "375703", "375705", "375706", "375707", "375708", "375709", "375711", "375712", "375713", "375714", "375715", "375716", "375717", "375718", "375719", "375720", "375721", "375722", "375723", "375724", "375725", "375726", "375727", "375729", "375730", "375731", "375732", "375733", "375734", "375735", "375737", "375738", "375739", "375740", "375741", "375742", "375743", "375744", "375745", "375747", "375748", "375749", "375750", "375752", "375753", "375754", "375756", "375757", "375758", "375759", "375760", "375761", "375762", "375763", "375764", "375765", "375766", "375767", "375769", "375770", "375771", "375772", "375773", "375774", "375775", "375776", "375777", "375778", "375779", "375780", "375781", "375782", "375783", "375784", "375785", "375786", "375787", "375789", "375790", "375791", "375792", "375793", "375794", "375795", "375796", "375797", "375798", "375800", "375801", "375802", "375803", "375804", "375805", "375806", "375807", "375808", "375809", "375810", "375811", "375812", "375813", "375814", "375815", "375816", "375817", "375818", "375819", "375820", "375821", "375823", "375825", "375826", "375828", "375832", "375833", "375834", "375835", "375836", "375837", "375838", "375839", "375840", "375841", "375842", "375854", "375855", "375857", "375859", "375861", "375862", "375868", "375871", "375878", "375884", "375885", "375886", "375887", "375892", "375894", "375901", "375904", "375906", "375907", "375909", "375912", "375914", "375916", "375917", "375924", "375926", "375927", "375928", "375929", "375932", "375941", "375942", "375945", "375946", "375971", "375986", "375995", "375998", "376002", "376014", "376017", "376021", "376081", "376082", "376083", "376084", "376085", "376086", "376087", "376088", "376089", "376090", "376091", "376092", "376093", "376094", "376095", "376096", "376097", "376098", "376099", "376100", "376101", "376102", "376103", "376104", "376105", "376106", "376107", "376108", "376109", "376110", "376111", "376112", "376113", "376115", "376116", "376117", "376118", "376119", "376120", "376121", "376122", "376123", "376124", "376125", "376126", "376127", "376128", "376129", "376130", "376131", "376132", "376133", "376134", "376135", "376136", "376141", "376142", "376161", "376162", "376163", "376179", "376180", "376181", "376197", "376198", "376199", "376215", "376216", "376236", "376237", "376238", "376257", "376258", "376259", "376273", "376274", "376275", "376291", "376292", "376293", "376313", "376314", "376315", "376316", "376332", "376333", "376334", "376349", "376350", "376351", "376367", "376368", "376369", "376387", "376388", "379051", "379052", "379053", "379054", "379055", "379056", "379057", "379058", "379059", "379060", "379061", "379062", "379063", "379064", "379065", "379067", "379068", "379070", "379071", "379072", "379073", "379074", "379076", "379077", "379078", "379079", "379080", "379081", "379082", "379083", "379084", "379085", "379086", "379087", "379088", "379089", "379090", "379091", "379092", "379093", "379094", "379095", "379096", "379097", "379098", "379099", "379100", "379101", "379102", "379103", "379105", "379106", "379107", "379108", "379109", "379110", "379111", "379112", "379113", "379114", "379116", "379117", "379118", "379119", "379120", "379121", "379122", "379123", "379124", "379126", "379127", "379128", "379129", "379130", "379131", "379132", "379133", "379134", "379135", "379136", "379137", "379138", "379139", "379140", "379141", "379142", "379143", "379144", "379145", "379146", "379147", "379148", "379149", "379150", "379151", "383536", "383537", "383538", "383539", "383540", "383541", "383542", "383543", "383544", "383545", "383546", "383547", "383548", "383576", "383632", "383633", "383634", "383635", "383697", "383698", "383699", "383700", "383701", "383702", "383703", "383704", "383705", "383706", "383707", "383772", "383773", "383774", "383776", "383777", "383778", "383779", "383780", "383781", "383782", "383783", "383784", "383790", "383791", "383792", "383793", "383794", "383795", "383796", "383797", "383798", "383799", "383800", "383801", "383802", "383803", "383804", "383805", "383806", "383807", "383808", "383809", "383810", "383811", "383813", "383814", "383815", "383816", "383817", "383818", "383819", "383820", "383821", "383822", "383823", "383824", "383825", "383826", "383827", "383828", "383829", "383830", "383831", "383832", "383833", "383834", "383835", "383836", "383837", "383838", "383839", "383840", "383841", "383842", "383843", "383844", "383845", "383846", "383847", "383848", "383849", "383850", "383851", "383852", "383853", "383854", "383855", "383856", "383857", "383858", "383859", "383860", "383861", "383862", "383864", "383865", "383866", "383867", "383869", "383870", "383871", "383872", "383873", "383874", "383875", "383876", "383877", "383878", "383879", "383880", "383881", "383882", "383883", "383884", "383885", "383886", "383887", "383888", "383889", "383890", "383891", "383892", "383893", "383894", "383895", "383896", "383897", "383898", "383900", "383901", "383902", "383903", "383904", "383905", "383906", "383907", "383908", "383909", "383910", "383911", "383912", "383913", "383914", "383915", "383916", "383917", "383918", "383919", "383920", "383921", "383922", "383923", "383924", "383925", "383926", "383927", "383928", "383929", "383930", "383931", "383932", "383933", "383934", "383935", "383936", "383937", "383938", "383939", "383941", "383942", "383943", "383944", "383945", "383946", "383947", "383948", "383949", "383950", "383951", "383952", "383953", "383954", "383955", "383956", "383957", "383958", "383959", "383960", "383961", "383962", "383963", "383964", "383966", "383967", "383968", "383969", "383970", "383972", "383973", "383974", "383975", "383976", "383977", "383978", "383979", "383980", "383981", "383982", "383983", "383984", "383985", "383986", "383987", "383988", "383989", "383990", "383991", "383992", "383993", "383994", "383995", "383996", "383997", "383998", "383999", "384000", "384001", "384002", "384003", "384004", "384005", "384006", "384007", "384008", "384009", "384010", "384011", "384012", "384013", "384014", "384015", "384016", "384018", "384019", "384020", "384021", "384022", "384023", "384024", "384025", "384026", "384027", "384028", "384029", "384030", "384031", "384032", "384033", "384034", "384035", "384036", "384037", "384038", "384039", "384040", "384041", "384043", "384045", "384046", "384047", "384048", "384049", "384051", "384053", "384055", "384057", "384059", "384061", "384062", "384065", "384067", "384069", "384071", "384074", "384075", "384077", "384079", "384082", "384083", "384085", "384087", "384089", "384092", "384093", "384095", "384096", "384098", "384100", "384103", "384104", "384105", "384108", "384110", "384112", "384114", "384115", "384117", "384120", "384122", "384124", "384127", "384129", "384130", "384131", "384133", "384135", "384137", "384139", "384141", "384143", "384145", "384146", "384149", "384152", "384154", "384156", "384158", "384159", "384162", "384164", "384168", "384171", "384172", "384174", "384176", "384178", "384181", "384182", "384184", "384187", "384188", "384190", "384192", "384194", "384197", "384200", "384203", "384205", "384207", "384209", "384210", "384211", "384212", "384213", "384214", "384215", "384216", "384219", "384220", "384221", "384222", "384224", "384227", "384229", "384234", "384236", "384239", "384241", "384246", "384250", "384254", "384256", "384259", "384260", "384262", "384263", "384274", "384275", "384276", "384277", "384279", "384294", "384306", "384307", "384309", "384310", "384311", "386010", "386011", "386012", "386013", "386014", "386015", "386016", "386017", "386019", "386097", "386098", "386099", "386100", "386126", "386127", "386128", "386129", "386130", "386131", "386159", "386160", "386161", "386162", "386163", "386164", "386165", "386166", "386167", "386168", "386169", "386194", "386195", "386196", "386197", "386198", "386200", "386201", "386202", "386204", "386205", "386207", "386238", "386240", "386242", "386244", "386246", "386248", "386250", "386277", "386279", "386281", "386282", "386285", "386287", "386313", "386315", "386317", "386320", "386322", "386323", "386327", "386329", "386360", "386361", "386365", "386366", "386369", "386372", "386406", "386411", "386412", "386414", "386415", "386420", "386421", "386426", "386430", "386508", "386510", "386511", "386721", "386723", "386725", "386727", "386730", "386741", "386743", "386744", "386745", "386747", "386752", "386753", "386755", "386756", "386758", "386802", "386804", "386805", "386808", "386810", "386814", "386817", "386818", "386823", "386827", "386830", "386831", "386834", "386865", "386867", "386869", "386870", "386874", "386875", "386877", "386879", "386881", "386883", "386909", "386911", "386914", "386915", "386918", "386919", "386922", "386923", "386925", "386950", "386951", "386956", "386959", "386960", "386961", "386964", "386967", "386968", "387031", "387032", "387035", "387037", "387041", "387043", "387046", "387047", "387048", "387050", "387055", "387057", "387058", "387060", "387061", "387062", "387063", "387065", "387066", "387195", "387197", "387198", "387199", "387201", "387202", "387203", "387204", "387205", "387206", "387208", "387209", "387214", "387222", "387228", "387229", "387237", "387243", "387248", "387249", "387250", "387252", "387253", "387254", "387255", "387256", "387257", "387258", "387259", "387261", "387262", "387263", "387264", "387265", "387266", "387268", "387270", "387271", "387273", "387274", "387275", "387276", "387371", "387373", "387374", "387375", "387376", "387377", "387378", "387379", "387380", "387381", "387382", "387383", "387385", "387386", "387387", "387388", "387389", "387390", "387391", "387393", "387394", "387396", "387397", "387398", "387399", "387401", "387402", "387404", "387405", "387406", "387407", "387408", "387409", "387410", "387411", "387437", "387438", "387439", "387440", "387441", "387442", "387443", "387444", "387445", "387467", "387468", "387469", "387470", "387495", "387496", "387497", "387498", "387499", "388440", "388472", "388473", "388508", "389481", "389482", "389483", "389484", "389485", "389486", "389487", "389488", "389490", "389491", "389492", "389493", "389494", "389495", "389496", "389497", "389498", "389499", "389500", "389501", "389502", "389503", "389504", "389506", "389507", "389508", "389509"]
    rows_deleted = db.query(LabelTask).filter(
        ~LabelTask.fmc_id.in_(valid_ids)
    ).delete(synchronize_session=False)
    db.commit()
    print(f'Deleted', rows_deleted)

    remaining_rows = db.query(LabelTask).all()
    print('reamining len', len(remaining_rows))
    print("Remaining rows:")
    for row in remaining_rows:
        if row.fmc_id not in valid_ids:
            print(f'Problem, {row.fmc_id} not valid but still in table')


@app.get('/')
async def get_index_html():
    return FileResponse('/static/index.html', headers={'Cache-Control': 'no-cache'})

@app.get('/leaderboard')
async def get_leaderboard_html():
    return FileResponse('/static/leaderboard.html', headers={'Cache-Control': 'no-cache'})

@app.get('/map')
async def get_map(labeler_name: str, level: int):
    level_to_map_id = max(0, min(level // 4, 6))
    return FileResponse(f'/static/img/stage{level_to_map_id}.png')

app.mount('/examples', StaticFiles(directory='/static/img/examples/'), name='examples')

Base.metadata.create_all(engine)

# TODO: probably not needed
if __name__ == '__main__':
    uvicorn.run('main:app', host='0.0.0.0', port=7100, reload=True)
