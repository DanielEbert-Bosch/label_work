<!DOCTYPE html>
<html>
  <head>
    <title>Bosch Label Taskforce</title>
    <style>
      body {
        font-family: sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }

      .container {
        background-color: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        text-align: center;
        width: 80%;
      }

      h1 {
        color: #333;
        margin-bottom: 50px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: #555;
        font-weight: bold;
        text-align: left;
      }

      input[type="text"] {
        width: 100%;
        padding: 10px;
        margin-bottom: 40px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box; /* To include padding and border in element's total width and height */
        font-size: 16px;
      }

      .nextmeasurement-button {
        background-color: #007bff; /* Modern blue color */
        color: white;
        padding: 24px 50px;
        width: 100%;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 24px;
        transition: background-color 0.3s ease; /* Smooth hover effect */
      }

      .nextmeasurement-button:hover {
        background-color: #0056b3; /* Darker blue on hover */
      }

      #xp-bar-container {
        background-color: #eee;
        border-radius: 8px;
        margin-top: 40px;
        margin-bottom: 40px;
        padding: 10px;
      }

      #xp-bar {
        background-color: #ddd;
        border-radius: 6px;
        height: 20px;
        overflow: hidden;
        position: relative;
      }

      #xp-progress {
        background-color: #28a745;
        height: 100%;
        border-radius: 6px;
        transition: width 0.5s ease;
      }

      #xp-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: rgb(31, 31, 31);
        font-size: 14px;
        font-weight: bold;
      }

      #labeling-instructions {
        text-align: left;
      }

      #labeling-examples img {
        max-width: 80vw;
        height: auto;
        padding-bottom: 15px;
      }

      #labeling-examples {
        font-size: 20px;
        padding-bottom: 2px;
        text-align: left;
      }

      @media (max-width: 600px) {
        .container {
          width: 90%;
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Bosch Label Taskforce</h1>

      <label for="user">User ID (example: abc1kor)</label>
      <input type="text" id="user" name="user" placeholder="Enter User ID" />

      <button class="nextmeasurement-button" onclick="openMeasurement()">
        Open Measurement
      </button>

      <div id="xp-bar-container">
        <div id="xp-bar">
          <div id="xp-progress">
            <div id="xp-text">60%</div>
          </div>
        </div>
      </div>

      <div>
        <img id="userMap" alt="Map" />
      </div>

      <div id="whyGuide">
      <h3>Why do we need labeling?</h3>
        <ul style="text-align: left;">
            <li>The labels you create are used to train a Machine Learning (ML) algorithm.</li>
            <li>This algorithm will be able to detect the height of an obstacle in the environment.</li>
            <li>We need you to mark *where* the obstacle is located.</li>
        </ul>

        <h3>What do we see when labeling?</h3>
        <ul style="text-align: left;">
            <li>Video recordings of driving scenarios.</li>
            <li>2D point clouds (lidar data) showing the environment as points.</li>
            <li>Visual hints in both video and point clouds that represent roads and obstacles. High density of points are a hint for an obstacle.</li>
            <li>Color-coded points that can highlight object height and shape.</li>
        </ul>

        <h3>Where do we want to go with labeling?</h3>
        <ul style="text-align: left;">
            <li>To create a dataset of accurately labeled obstacles in various parking situations with various types of obstacles.</li>
            <li>For each recording, we aim to identify and precisely outline <strong>one</strong> key obstacle we are approaching.</li>
            <li>We want to ensure the labels include correct information about the obstacle type and height.</li>
        </ul>

        <h3>How do we do labeling (Detailed Guide below)?</h3>
        <ul style="text-align: left;">
            <li>We use a labeling tool that visualizes synchronized video and lidar data.</li>
            <li>We draw a polygon directly on the lidar point cloud to outline obstacles.</li>
            <li>We focus on labeling <strong>one</strong> specific obstacle in each recording.</li>
            <li>We verify the automatically assigned obstacle type and height using the video and point cloud.</li>
            <li>We save our work and communicate with the team to ensure consistency and quality.</li>
        </ul>
      </div>

      <h2>Labeling Guide</h2>
      <div id="labeling-instructions">
        <ol>
          <li><strong>Open Measurement</strong></li>
          <li>
            [<strong>Initial Setup</strong> (First time only)] If its your first time labeling, watch the video below for a quick overview. Then, in the opened window
            <ul>
                <li>Hover over the '<' icon (top right) to open the side panel.</li>
                <li>Select these layers (most recent timestamp if multiple options):
                <ul>
                    <li>"Object PCD *"</li>
                    <li>"Road PCD *"</li>
                    <li>"Contour *"</li>
                </ul>
                </li>
            </ul> 
          </li>
          <li>
            <strong>Troubleshooting: Report Issues</strong>
            If anything seems wrong (e.g., no video, missing obstacles), immediately:
            <ul>
                <li>Share the measurement link in the Labeling Taskforce chat or with Daniel (ebd7rng).</li>
                <li>Close the measurement and return to step 1.</li>
            </ul> 
          </li>
          <li>
            <strong>Create Polygon: Label Obstacle:</strong>
            In the right panel, click to create points around the obstacle's corners.
            <ul>
                <li>Always label 1 obstacle (not more): The obstacle we are driving towards (no matter if we are driving forward or backward). Ignore other obstacles, such as a wall further away.</li>
                <li>Minimum 4 points.</li>
                <li>Points should be just outside the obstacle.</li>
                <li>Double-click to finalize the polygon.</li>
            </ul>
          </li>
          <li>
            <strong>Verify Metadata: Check Object Type & Height</strong>
            <br/>
            Hover over a polygon corner to see object type and height.
            <ul>
                <li>Use the video (left side) to confirm the metadata is correct.</li>
                <li>Refer to example images below for valid/invalid metadata examples.</li>
                <li>If metadata is wrong, report the issue as in step 3 and restart.</li>
            </ul>
          </li>
          <li>
            <strong>Optional Restart: Redo Polygon</strong>
            <br/>
            To restart the polygon (e.g., if you misclicked), simply reload the page and go back to step 4.
          </li>
          <li>
            <strong>Save Label: Press "s" (Green Icon Confirmation!)</strong>
            <br/>
            Press "s" to save.  <strong>Ensure the Save icon (top right) turns GREEN to confirm saving.</strong>
          </li>
        </ol>

        <p>
          <strong>Teamwork:</strong> Work as a team! Share tips, tricks, and insights on
          effective and accurate labeling in the Labeling Taskforce Teams Chat. Discuss challenging cases and support
          each other to maintain consistent quality. Knowledge sharing is
          crucial.
        </p>
        <p><strong>Questions?</strong> Contact Daniel (ebd7rng) on Teams or in the Labeling Taskforce chat anytime. Happy to help! ^_^</p>
        <p><strong>Example Labeling & Scenarios:</strong> See the examples below for visual guidance.</p>

        Example Labeling of a Measurement:<br/>
        <video width="1280" height="500" controls preload="metadata">
          <source
            src="http://fe-c-017ev.lr.de.bosch.com:7100/examples/labelExample.mp4"
            type="video/mp4"
          />
          Your browser does not support the video tag.
        </div>
        <h2>Example Labeled Measurements</h2>
        <div id="labeling-examples">
            <br/>Box Example. Lidar points above 15cm are colored differently (in this case: black). Therefore, draw a polygon around these black points. Watch the video on the left to understand the obstacle type.<br/>
            <img src="http://localhost:7100/examples/box.png">
            <br/>Points very close to the obstacle are hidden. Use the time slider to go back and see points closer to the obstacle.<br/>
            <img src="http://localhost:7100/examples/timeSlider.png">
            <br/>For obstacles >15cm, turning off road points (height <15cm) can be helpful. Toggle road points here:<br/>
            <img src="http://localhost:7100/examples/showRoadPcd.png">
            <br/>And for heigh obstacles, its easier to identify and label the obstacle:<br/>
            <img src="http://localhost:7100/examples/box8.png">
            The obstacle is where points accumulate:<br/>
            <img src="http://localhost:7100/examples/box2.png">
            Very high obstacles block points behind them. This free space behind obstacles is an indication where the obstacle is placed, and therefore an indication for where we should place our label, for example:<br/>
            <img src="http://localhost:7100/examples/box3.png">
            <br/> Hover over polygons to check obstacle type and height. Verify metadata validity using the video and obstacle shape.<br/>
            <br/>Example of valid metadata:<br/>
            <img src="http://localhost:7100/examples/validMetadata.png">
            <br/> Example of invalid Metadata:<br/>
            <img src="http://localhost:7100/examples/invalidMetadata.png">
            <img src="http://localhost:7100/examples/box4.png">
            <img src="http://localhost:7100/examples/box5.png">
            <img src="http://localhost:7100/examples/box6.png">
            <img src="http://localhost:7100/examples/box7.png">
            <img src="http://localhost:7100/examples/box9.png">
            <img src="http://localhost:7100/examples/box10.png">
            <br/> Curbstone example. For obstacles <15cm, all points are the same color. Look for point accumulation along the obstacle's shape:<br/>
            <img src="http://localhost:7100/examples/curbstone1.png">
            <br/> Color-coding road points by height can help with low obstacles. Guide:<br/>
            <img src="http://localhost:7100/examples/colorRoadPoints.png">
            <br/> Curbstone example with road point color-coding. Curbstone points are darker orange.<br/>
            <img src="http://localhost:7100/examples/curbstone2.png">
            <br/> Dummy Obstacle. Use more than 4 points for accurate polygons.<br/>
            <img src="http://localhost:7100/examples/dummy1.png">
            <img src="http://localhost:7100/examples/dummy2.png">
            <br/> Always label exactly one obstacle, the one we are driving towards. In rare cases, that obstacle can be some meters away.<br/>
            <img src="http://localhost:7100/examples/farAway.png">
            <br/> Obstacles may be hard to see in the video. Rely on lidar points in such cases.<br/>
            <img src="http://localhost:7100/examples/hardToSee.png">
            <img src="http://localhost:7100/examples/hardToSee2.png">
            <img src="http://localhost:7100/examples/highObstacle.png">
            <br/> Speedbump example. Hardest to label. Use the time slider to see point accumulation from different angles. If you are unsure, report (post link in Labeling Taskforce teams chat) and skip the measurement.<br/>
            <img src="http://localhost:7100/examples/speedbump.png">
            <br/> Same speedbump, further away. Point cloud accumulation is clearer.<br/>
            <img src="http://localhost:7100/examples/speedbump3.png">
            <br/> Pole. Easy to see in the video later in the measurement, but lidar points may disappear. Use the time slider to go back to where the pole is visible in lidar, and draw a polygon there.<br/>
            <img src="http://localhost:7100/examples/pole1.png">
            <br/> Same pole, further away. Point cloud accumulation is clearer.<br/>
            <img src="http://localhost:7100/examples/pole2.png">
        </div>
        <h2>Community Suggestions ^_^</h2>
        <div style="text-align: left;">
            <ul>
                <li>check first if the car is moving forward or backward (on the top right corner you can check if it the camera moves with the car), then open the front or back camera in a Picture in Picture to see it more clearly.</li>
                <li>Then start the record again and try to see what the obstacle can be</li>
                <li>Then stop it at a time when the obstacle can be seen the best, then draw the polygon</li>
                <li>Then exit the drawing stage with double-click somewhere on the right panel</li>
                <li>then zoom in to see your drawing better, hovering over it shows what type it recognizes</li>
            </ul>
            <img src="http://localhost:7100/examples/carDirection.png">
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <script>
      const backend = window.location.hostname;
      let currentXP = 0;
      let previousLevel = -1;

      function loadMap(user, level) {
        const mapurl = new URL(`http://${backend}:7100/map`);
        mapurl.searchParams.append("labeler_name", user);
        mapurl.searchParams.append("level", level);

        fetch(mapurl)
          .then((response) => response.blob())
          .then((blob) => {
            const tempImg = new Image();
            tempImg.src = URL.createObjectURL(blob);

            tempImg.onload = () => {
              const imgUrl = URL.createObjectURL(blob);
              const imgElement = document.getElementById("userMap");
              imgElement.src = imgUrl;
              imgElement.width = tempImg.width * 2;
              imgElement.height = tempImg.height * 2;
            };
          })
          .catch((error) => {
            console.error("Error fetching or processing image:", error);
          });
      }

      function openMeasurement() {
        const user = document.getElementById("user").value;
        if (user == "") {
          alert("To start labeling, set your username in the text field.");
          return;
        }
        localStorage.setItem("labelingUser", user);

        // TODO: replace with server
        const url = new URL(`http://${backend}:7100/api/get_task`);
        url.searchParams.append("labeler_name", user);

        fetch(url)
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            console.log("Fetched data:", data);

            if ("finished" in data) {
              confetti({
                particleCount: 200,
                spread: 70,
                origin: { y: 0.6 },
              });
              alert("Wow! All measurements are labeled ^_^");
              return;
            }

            const sia_url = data["sia_url"];

            const screenWidth = window.screen.availWidth;
            const screenHeight = window.screen.availHeight;

            const newWindowWidth = screenWidth * 0.7;
            const newWindowHeight = screenHeight;

            var left = screenWidth * 0.3 + window.screenX;
            var top = 0;

            const features = `width=${newWindowWidth},height=${newWindowHeight},left=${left},top=${top},noopener,noreferrer`;
            window.open(sia_url, "_blank", features);

            currentXP += 73;
            setXPBar(currentXP);
            localStorage.setItem("labelingXP", currentXP);
          })
          .catch((error) => {
            console.error("Fetch error:", error);
            alert("Failed to fetch data. See console for details.");
          });
      }

      function setXPBar(currentXP) {
        let level = 1;
        let xpToNextLevel = 100;
        console.log(currentXP)
        while (currentXP >= xpToNextLevel) {
          level += 1;
          currentXP -= xpToNextLevel;
          xpToNextLevel *= 1.15;
        }

        if (previousLevel > 0 && previousLevel != level) {
          confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 },
          });
        }
        if (previousLevel == 0 || previousLevel != level) {
          loadMap(user, level);
        }
        previousLevel = level;

        const progressBar = document.getElementById("xp-progress");
        const xpText = document.getElementById("xp-text");

        const percentage = (currentXP / xpToNextLevel) * 100;
        progressBar.style.width = percentage + "%";
        console.log(percentage);

        xpText.textContent = `Level: ${level}  (${Math.floor(
          currentXP
        )} / ${Math.floor(xpToNextLevel)})`;

        if (percentage === 100) {
          progressBar.style.borderRadius = "5px";
        } else {
          progressBar.style.borderRadius = "5px 0 0 5px";
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        const productionURL = 'fe-c-017ev.lr.de.bosch.com';
        if (window.location.hostname === productionURL) {
            const images = document.querySelectorAll('img');
            const mp4s = document.querySelectorAll('source')
            images.forEach((img) => {
                ['localhost', '127.0.0.1'].forEach((localhost) => {
                    if (img.src.includes(localhost)) {
                        img.src = img.src.replace(localhost, productionURL)
                    }
                })
            })
            mp4s.forEach((mp4) => {
                ['localhost', '127.0.0.1'].forEach((localhost) => {
                    if (mp4.src.includes(localhost)) {
                        mp4.src = mp4.src.replace(localhost, productionURL)
                    }
                })
            })
        }

        // doesn't work if someone changes browsers, but leaderboard is anyway on server
        currentXP = Number(localStorage.getItem("labelingXP"))
          ? Number(localStorage.getItem("labelingXP"))
          : 0;
        setXPBar(currentXP);

        const prevUser = localStorage.getItem("labelingUser", user);
        if (prevUser) {
          document.getElementById("user").value = prevUser;
        }
      });
    </script>
  </body>
</html>
