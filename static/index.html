<!DOCTYPE html>
<html>
  <head>
    <title>Label Taskforce</title>
    <style>
      body {
        font-family: sans-serif;
        line-height: 1.2;
        background-color: #f8f8f8;
        color: #333;
        margin: 20px;
      }

      h1 {
        font-size: 2em;
        color: #555;
        margin-bottom: 20px;
        text-align: center;
      }

      .clear-button {
        background-color: red;
        color: white;
        padding: 10px 20px;
        border: none;
        cursor: pointer;
        border-radius: 5px;
        font-size: 16px;
      }

      .clear-button:hover {
        background-color: darkred;
      }

      #xp-bar-container {
        position: sticky;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: #f1f1f1;
        color: white;
        padding: 10px;
        padding-bottom: 20px;
        box-shadow: 0px -2px 5px rgba(0, 0, 0, 0.2);
        box-sizing: border-box;
      }

      #xp-bar {
        width: 100%;
        height: 30px;
        background-color: #555;
        border-radius: 5px;
        overflow: hidden;
        position: relative;
      }

      #xp-progress {
        height: 100%;
        background-color: #4caf50;
        width: 0;
        transition: width 0.5s ease-in-out;
        border-radius: 5px 0 0 5px;
      }

      #xp-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 14px;
        white-space: nowrap; /* Prevent text from wrapping */
      }
    </style>
  </head>
  <body>
    <h1>Label Taskforce</h1>

    <label for="user">User ID (example: abc1kor):</label> <br />
    <input type="text" id="user" name="" />

    <button class="nextmeasurement-button" onclick="openMeasurement()">
      Open Measurement
    </button>

    <div id="xp-bar-container">
      <div id="xp-bar">
        <div id="xp-progress"></div>
        <div id="xp-text"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <script>
      let currentXP = 0;
      let previousLevel = -1;

      function openMeasurement() {
        const user = document.getElementById("user").value;
        if (user == "") {
          alert("To start labeling, set your username in the text field.");
          return;
        }
        localStorage.setItem("labelingUser", user);

        // TODO: replace with server
        const baseUrl = "http://localhost:7100/api/get_task";
        const url = new URL(baseUrl);

        url.searchParams.append("labeler_name", user);

        fetch(url)
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            console.log("Fetched data:", data);

            if ('finished' in data) {
                confetti({
                    particleCount: 200,
                    spread: 70,
                    origin: { y: 0.6 },
                });
                alert('Wow! All measurements are labeled ^_^');
                return;
            }

            const sia_url = data['sia_url'];

            const screenWidth = window.screen.availWidth;
            const screenHeight = window.screen.availHeight;

            const newWindowWidth = screenWidth * 0.7;
            const newWindowHeight = screenHeight;

            var left = screenWidth * 0.3 + window.screenX;
            var top = 0;

            const features = `width=${newWindowWidth},height=${newWindowHeight},left=${left},top=${top},noopener,noreferrer`;
            window.open(sia_url, "_blank", features);

            currentXP += 73;
            setXPBar(currentXP);
            localStorage.setItem("labelingXP", currentXP);
          })
          .catch((error) => {
            console.error("Fetch error:", error);
            alert("Failed to fetch data. See console for details.");
          });
      }

      function setXPBar(currentXP) {
        let level = 1;
        let xpToNextLevel = 250;
        while (currentXP > xpToNextLevel) {
          level += 1;
          currentXP -= xpToNextLevel;
          xpToNextLevel *= 1.15;
        }

        if (previousLevel > 0 && previousLevel != level) {
          confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 },
          });
        }
        previousLevel = level;

        const progressBar = document.getElementById("xp-progress");
        const xpText = document.getElementById("xp-text");

        const percentage = (currentXP / xpToNextLevel) * 100;
        progressBar.style.width = percentage + "%";

        xpText.textContent = `Level: ${level}  (${Math.floor(
          currentXP
        )} / ${Math.floor(xpToNextLevel)})`;

        if (percentage === 100) {
          progressBar.style.borderRadius = "5px";
        } else {
          progressBar.style.borderRadius = "5px 0 0 5px";
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        // doesn't work if someone changes browsers, but leaderboard is anyway on server
        currentXP = localStorage.getItem("labelingXP")
          ? localStorage.getItem("labelingXP")
          : 0;
        setXPBar(currentXP);

        const prevUser = localStorage.getItem("labelingUser", user);
        if (prevUser) {
            document.getElementById("user").value = prevUser;
        }
      });
    </script>
  </body>
</html>
