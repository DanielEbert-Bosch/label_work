<!DOCTYPE html>
<html>
  <head>
    <title>Bosch Label Taskforce</title>
    <style>
      body {
        font-family: sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }

      .container {
        background-color: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        text-align: center;
        width: 80%;
      }

      h1 {
        color: #333;
        margin-bottom: 50px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: #555;
        font-weight: bold;
        text-align: left;
      }

      input[type="text"] {
        width: 100%;
        padding: 10px;
        margin-bottom: 40px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box; /* To include padding and border in element's total width and height */
        font-size: 16px;
      }

      .nextmeasurement-button {
        background-color: #007bff; /* Modern blue color */
        color: white;
        padding: 24px 50px;
        width: 100%;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 24px;
        transition: background-color 0.3s ease; /* Smooth hover effect */
      }

      .nextmeasurement-button:hover {
        background-color: #0056b3; /* Darker blue on hover */
      }

      #xp-bar-container {
        background-color: #eee;
        border-radius: 8px;
        margin-top: 40px;
        margin-bottom: 40px;
        padding: 10px;
      }

      #xp-bar {
        background-color: #ddd;
        border-radius: 6px;
        height: 20px;
        overflow: hidden;
        position: relative;
      }

      #xp-progress {
        background-color: #28a745;
        height: 100%;
        border-radius: 6px;
        transition: width 0.5s ease;
      }

      #xp-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: rgb(31, 31, 31);
        font-size: 14px;
        font-weight: bold;
      }

      #labeling-instructions {
        text-align: left;
      }

      #labeling-examples img {
        max-width: 80vw;
        height: auto;
        padding-bottom: 15px;
      }

      #labeling-examples {
        font-size: 20px;
        padding-bottom: 2px;
        text-align: left;
      }

      @media (max-width: 600px) {
        .container {
          width: 90%;
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Bosch Label Taskforce</h1>

      <label for="user">User ID (example: abc1kor)</label>
      <input type="text" id="user" name="user" placeholder="Enter User ID" />

      <button class="nextmeasurement-button" onclick="openMeasurement()">
        Open Measurement
      </button>

      <div id="xp-bar-container">
        <div id="xp-bar">
          <div id="xp-progress">
            <div id="xp-text">60%</div>
          </div>
        </div>
      </div>

      <div>
        <img id="userMap" alt="Map" />
      </div>

      <h2>Labeling Guide</h2>
      <div id="labeling-instructions">
        <ol>
          <li>Open Measurement</li>
          <li>
            [First time only] Visualize: In the opened window, open the side
            panel and select "Object PCD *" and "Road PCD *" and "Contour *". If
            multiple * are available, select the most recent timestamp.
          </li>
          <li>
            If there is anything wrong, for example no videos or no obstacles are visible,
            please post a link to the opened Measurement in the Labeling Taskforce team chat,
            and close the measurement and go to step 1.
          </li>
          <li>
            Click multiple times to create a polygon around the obstacle. The
            polygon must have at minimum 4 points. The points must be outside
            the obstacle, but as close as possible to the obstacle.
          </li>
          <li>
            [Optional] To restart, e.g. when something goes wrong, reload the
            page and go to step 3.
          </li>
          <li>
            Save the label: Press "s" to save. Make sure the Save Icon in the
            top right plot corner turns green.
          </li>
        </ol>

        <p>
          Teamwork: Work as a team! Share tips, tricks, and insights on
          effective and accurate labeling. Discuss challenging cases and support
          each other to maintain consistent quality. Knowledge sharing is
          crucial.
        </p>
        <p>
          If you have any questions, please reach out to Daniel (ebd7rng) on
          Teams or in the Labeling Taskforce team chat.
        </p>
        <p>Example: TODOebd7rng provides video</p>
        <video width="640" height="360" controls preload="metadata">
          <source
            src="ahttps://www.w3schools.com/html/mov_bbb.mp4"
            type="video/mp4"
          />
          Your browser does not support the video tag.
        </div>
        <h2>Example Labeled Measurements</h2>
        <div id="labeling-examples">
            <br/>Box Example. Lidar points with a height of >15cm have a different color, in this example a black color. Therefore, if our obstacle is high, draw a polygon around the black points. Checkout the video to see what type of obstacle we are driving towards.
            <img src="http://localhost:7100/examples/box.png">
            <br/>Points very close to the obstacle are not shown, therefore it is often useful to go back in time by dragging the slider:
            <img src="http://localhost:7100/examples/timeSlider.png">
            <br/>In scenes with an obstacle of height >15cm its often useful to turn off the road points. Road points have height <15cm. To toggle road points on and off:
            <img src="http://localhost:7100/examples/showRoadPcd.png">
            <br/>And for heigh obstacles, its easy to see and label the obstacle:
            <img src="http://localhost:7100/examples/box8.png">
            The obstacle is where there is an accumulation of points, e.g.:
            <img src="http://localhost:7100/examples/box2.png">
            Very high obstacles block off any points, therefore for such obstacles there won't be any points behind the obstacle.
            <img src="http://localhost:7100/examples/box3.png">
            <img src="http://localhost:7100/examples/box4.png">
            <img src="http://localhost:7100/examples/box5.png">
            <img src="http://localhost:7100/examples/box6.png">
            <img src="http://localhost:7100/examples/box7.png">
            <img src="http://localhost:7100/examples/box9.png">
            <img src="http://localhost:7100/examples/box10.png">
            <br/> Curbstone example. For obstacles with a height of <15cm, we just have 1 color for all points. This makes it harder to see where the obstacle is located. However, there is an accumulation along the bounding box of the obstacle:
            <img src="http://localhost:7100/examples/curbstone1.png">
            <br/> We can color the road points based on their height. This is often useful for low height obstacles. Guide:
            <img src="http://localhost:7100/examples/colorRoadPoints.png">
            <br/> This is the same curbstone from the image above, with color coding enabled. You can see that the curbstone points have a darker orange color, compared to the immediate surrounding points.
            <img src="http://localhost:7100/examples/curbstone2.png">
            <br/> Dummy Obstacle. Feel free to use more than 4 points to accurately capture the obstacle.
            <img src="http://localhost:7100/examples/dummy1.png">
            <img src="http://localhost:7100/examples/dummy2.png">
            <br/> Always label the one obstacle that we are driving towards. In rare cases, that obstacle can be some meters away.
            <img src="http://localhost:7100/examples/farAway.png">
            <br/> In this scenario, its very hard to see the obstacle in the lidar camera on the left. In this case, rely on the lidar points on the right.
            <img src="http://localhost:7100/examples/hardToSee.png">
            <img src="http://localhost:7100/examples/hardToSee2.png">
            <img src="http://localhost:7100/examples/highObstacle.png">
            <br/> Speedbump example. These are the hardest to label. Difficult to see in the lidar points because there is not a large accumulation. You can drag the time slider, often its easier to see where the obstacle is by viewing the lidar points at different timestamps, e.g. the second image below is from further away, and there its easier to see the accumulation.
            <img src="http://localhost:7100/examples/speedbump.png">
            <br/> Same speedbump from above, but from further away.
            <img src="http://localhost:7100/examples/speedbump3.png">
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <script>
      const backend = window.location.hostname;
      let currentXP = 0;
      let previousLevel = -1;

      function loadMap(user, level) {
        const mapurl = new URL(`http://${backend}:7100/map`);
        mapurl.searchParams.append("labeler_name", user);
        mapurl.searchParams.append("level", level);

        fetch(mapurl)
          .then((response) => response.blob())
          .then((blob) => {
            const tempImg = new Image();
            tempImg.src = URL.createObjectURL(blob);

            tempImg.onload = () => {
              const imgUrl = URL.createObjectURL(blob);
              const imgElement = document.getElementById("userMap");
              imgElement.src = imgUrl;
              imgElement.width = tempImg.width * 2;
              imgElement.height = tempImg.height * 2;
            };
          })
          .catch((error) => {
            console.error("Error fetching or processing image:", error);
          });
      }

      function openMeasurement() {
        const user = document.getElementById("user").value;
        if (user == "") {
          alert("To start labeling, set your username in the text field.");
          return;
        }
        localStorage.setItem("labelingUser", user);

        // TODO: replace with server
        const url = new URL(`http://${backend}:7100/api/get_task`);
        url.searchParams.append("labeler_name", user);

        fetch(url)
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            console.log("Fetched data:", data);

            if ("finished" in data) {
              confetti({
                particleCount: 200,
                spread: 70,
                origin: { y: 0.6 },
              });
              alert("Wow! All measurements are labeled ^_^");
              return;
            }

            const sia_url = data["sia_url"];

            const screenWidth = window.screen.availWidth;
            const screenHeight = window.screen.availHeight;

            const newWindowWidth = screenWidth * 0.7;
            const newWindowHeight = screenHeight;

            var left = screenWidth * 0.3 + window.screenX;
            var top = 0;

            const features = `width=${newWindowWidth},height=${newWindowHeight},left=${left},top=${top},noopener,noreferrer`;
            window.open(sia_url, "_blank", features);

            currentXP += 73;
            setXPBar(currentXP);
            localStorage.setItem("labelingXP", currentXP);
          })
          .catch((error) => {
            console.error("Fetch error:", error);
            alert("Failed to fetch data. See console for details.");
          });
      }

      function setXPBar(currentXP) {
        let level = 1;
        let xpToNextLevel = 100;
        console.log(currentXP)
        while (currentXP >= xpToNextLevel) {
          level += 1;
          currentXP -= xpToNextLevel;
          xpToNextLevel *= 1.15;
        }

        if (previousLevel > 0 && previousLevel != level) {
          confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 },
          });
        }
        if (previousLevel == 0 || previousLevel != level) {
          loadMap(user, level);
        }
        previousLevel = level;

        const progressBar = document.getElementById("xp-progress");
        const xpText = document.getElementById("xp-text");

        const percentage = (currentXP / xpToNextLevel) * 100;
        progressBar.style.width = percentage + "%";
        console.log(percentage);

        xpText.textContent = `Level: ${level}  (${Math.floor(
          currentXP
        )} / ${Math.floor(xpToNextLevel)})`;

        if (percentage === 100) {
          progressBar.style.borderRadius = "5px";
        } else {
          progressBar.style.borderRadius = "5px 0 0 5px";
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        const images = document.querySelectorAll('img');
        const productionURL = 'fe-c-017ev.lr.de.bosch.com';
        if (window.location.hostname === productionURL) {
            images.forEach((img) => {
                ['localhost', '127.0.0.1'].forEach((localhost) => {
                    if (img.src.includes(localhost)) {
                        img.src = img.src.replace(localhost, productionURL)
                    }
                })
            })
        }

        // doesn't work if someone changes browsers, but leaderboard is anyway on server
        currentXP = Number(localStorage.getItem("labelingXP"))
          ? Number(localStorage.getItem("labelingXP"))
          : 0;
        setXPBar(currentXP);

        const prevUser = localStorage.getItem("labelingUser", user);
        if (prevUser) {
          document.getElementById("user").value = prevUser;
        }
      });
    </script>
  </body>
</html>
